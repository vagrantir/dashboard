function _log(e){logs&&console.log(e)}function tmpstmp(){return Math.floor(Date.now()/1e3)}var browser,baseUrl=chrome.runtime.getManifest().homepage_url,updateShopsPeriod=30,sendStatPeriod=30,updateShopPeriod=10,updateCouponsPeriod=30,notifyCheckPeriod=30,logs=!0,v=chrome.runtime.getManifest().version,currentDomain="",injectMatches={yandex:["https://yandex.ru/search/*","https://yandex.by/search/*","https://yandex.kz/search/*","https://yandex.ua/search/*"],google:["https://www.google.com/*","https://www.google.com.ua/*","https://www.google.ru/*","https://www.google.by/*","https://www.google.kz/*","https://www.google.us/*","https://www.google.co.in/*"]};window.pulseTimeout=0,window.pulseInterval=0;var API=new _api(self);navigator&&navigator.userAgent&&(browser=navigator.userAgent.match(/YaBrowser/gi)?"yandex":navigator.userAgent.match(/ OPR/gi)?"opera":"chrome"),$isGreen=!1,chrome.windows.onCreated.addListener(function(){chrome.windows.getCurrent(function(e){chrome.tabs.query({windowId:e.id},function(e){$.each(e,function(e,t){bg.removeCookies(t.url)})})})}),window.pulseTimeout=0,window.pulseInterval=0,chrome.runtime.onInstalled.addListener(function(e){chrome.storage.local.set({hits:[],utm:[],mon:[],coupons:{},shops_hash:"",coupons_hash:"",lastCallUpdateShops:0}),chrome.alarms.clearAll(function(){chrome.alarms.create("updateShops",{when:Date.now(),periodInMinutes:updateShopsPeriod}),chrome.alarms.create("sendStat",{when:Date.now(),periodInMinutes:sendStatPeriod}),chrome.alarms.create("notifyCheck",{when:Date.now(),periodInMinutes:notifyCheckPeriod})}),"install"===e.reason?(chrome.storage.local.clear(),API.post("install",null,function(e){e&&bg.updateUserData(e)}),bg.isLogged(function(e){chrome.tabs.create({url:baseUrl+"/plugin-guide/2?utm_source=plugin&utm_medium="+browser+"&utm_term="+(e||0)+"&utm_content=install"})})):"update"===e.reason&&("2.0.0"===v&&chrome.storage.local.clear(),API.post("update",null,function(e){e&&bg.updateUserData(e)}))}),chrome.cookies.get({url:baseUrl,name:"ext_user_id"},function(e){var t=e&&e.value?e.value:0;chrome.runtime.setUninstallURL(baseUrl+"/extension_uninstall.html?browser="+browser+"&utm_source=plugin&utm_medium="+browser+"&utm_term="+(t||0)+"&utm_content=del")}),chrome.alarms.onAlarm.addListener(function(e){chrome.storage.local.get(function(t){switch(e.name){case"notifyCheck":(void 0===t.notifyLastDate||0===t.notifyLastDate||t.notifyLastDate<=tmpstmp()-60*notifyCheckPeriod)&&API.get("notify/list",{lastDate:void 0!==t.notifyLastDate?t.notifyLastDate:""},function(e){"object"!=typeof t.notifications&&(t.notifications=[]),$.each(e.notifications,function(e,o){o.viewed=!1,t.notifications.push(o)}),chrome.storage.local.set({notifyLastDate:tmpstmp(),notifications:t.notifications},function(){$.each(t.notifications,function(e,t){if(!t.viewed)return chrome.notifications.create("notify_"+t.id,{type:"basic",iconUrl:"img/icons/icon48.png",title:t.title,message:t.text,contextMessage:chrome.runtime.getManifest().name}),!1})})});break;case"updateShops":(void 0===t.lastCallUpdateShops||0===t.lastCallUpdateShops||t.lastCallUpdateShops<=tmpstmp()-60*updateShopsPeriod)&&bg.updateShops();break;case"sendStat":(void 0===t.lastStatSended||0===t.lastStatSended||t.lastStatSended<=tmpstmp()-60*sendStatPeriod)&&API.sendStat()}})}),chrome.notifications.onClicked.addListener(function(e){bg.notifyAction(e,!0)}),chrome.notifications.onClosed.addListener(function(e,t){1==t&&bg.notifyAction(e,!1)}),chrome.windows.onFocusChanged.addListener(function(e){chrome.tabs.query({active:!0,windowId:e},function(e){void 0!==e[0].url&&bg.onChange(e[0].url,e[0].id,null,-1)})}),chrome.tabs.onActivated.addListener(function(e){chrome.tabs.query({active:!0,windowId:e.windowId},function(e){void 0!==e[0].url&&bg.onChange(e[0].url,e[0].id,null,-1)})}),chrome.tabs.onUpdated.addListener(function(e,t,o){bg.showCashbackNotifyIfNeeded(o),"complete"===t.status&&bg.getPartner(o.url,function(n){n?chrome.cookies.get({url:baseUrl,name:"actived_cashback"},function(n){chrome.tabs.executeScript(e,{code:"document.referrer;"},function(a){"object"==typeof a&&Object.keys(a).length&&(a=a[0]),n=null!==n?n.value:0,bg.onChange(o.url,e,t.status,a,n)})}):bg.onChange(o.url,e,t.status),bg.isLogged(function(e){e?chrome.storage.local.get(function(e){bg.getHostName(o.url);!$.isEmptyObject(e.mon)&&e.mon.length||(e.mon=[]),!$.isEmptyObject(e.monList)&&e.monList.length&&bg.isActive(o.url,function(t){chrome.cookies.get({url:"http://"+bg.getHostName(o.url)+"/",name:"smarty.sale_closed_notify"},function(a){$.each(e.monList,function(s,i){var c=new RegExp("^"+i.replace(".","."));void 0!==o.url&&o.url.match(c)&&(e.mon.push([o.url,void 0!==n?n.id:0,Math.floor(Date.now()/1e3),t?1:0,a&&1!=a.value||!a?1:0]),chrome.storage.local.set({mon:e.mon}))})})},-1,!1)}):chrome.storage.local.set({mon:[]})})})}),chrome.runtime.onMessage.addListener(function(e,t,o){switch(e.do){case"close_notify":chrome.windows.getCurrent(function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){bg.getPartner(e[0].url,function(e){chrome.cookies.set({url:"http://"+bg.getHostName(e.url)+"/",name:"smarty.sale_closed_notify",value:"1",path:"/",expirationDate:(new Date).getTime()/1e3+86400,domain:bg.getHostName(e.url)})})})});break;case"cashback":bg.getCashback(e.id,e.url,e.new_tab,e.url);break;case"login":chrome.windows.getCurrent(function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){bg.onChange(e[0].url,e[0].id,"complete","")})});break;case"logout":chrome.windows.getCurrent(function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){bg.removeCookies(e[0].url,function(){bg.onChange(e[0].url,e[0].id,"complete","")})})});break;case"goToUrl":chrome.windows.getCurrent(function(t){chrome.tabs.query({active:!0,windowId:t.id},function(t){chrome.tabs.update(t[0].id,{url:e.url,active:!0})})});break;case"catalogUrl":bg.isLogged(function(e){chrome.tabs.create({url:baseUrl+"/shops?utm_source=plugin&utm_medium="+browser+"&utm_term="+(e||0)+"&utm_content=hidden",active:!0})});break;case"logoClick":bg.isLogged(function(e){chrome.tabs.create({url:baseUrl+"/?utm_source=plugin&utm_medium="+browser+"&utm_term="+(e||0)+"&utm_content=logo",active:!0})});break;case"checkCashback":bg.getPartner(e.url,function(e){o({result:!1!==e&&!e.plugin_hide,cashback:e.cashback})});break;case"checkInject":chrome.windows.getCurrent(function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){$.each(injectMatches,function(t,n){$.each(n,function(n,a){if(new RegExp("^"+a,"gi").test(e[0].url))return o({result:!0,inject:t}),!0})}),o({result:!1})})})}return!0});var BG=function(){var e=this;$.extend(this,{updateCouponsIfNeeded:function(e,t){chrome.storage.local.get(function(o){var n=!0;void 0!==o.coupons&&void 0!==o.coupons[e]&&(n=void 0===o.coupons[e].lastUpdated||0===o.coupons[e].lastUpdated||o.coupons[e].lastUpdated<=tmpstmp()-60*updateCouponsPeriod),void 0===o.coupons&&(o.coupons={}),n?API.get(0!=e?"coupons/list":"coupons/top",{id:e},function(n){o.coupons[e]={coupons:n,lastUpdated:tmpstmp()},chrome.storage.local.set({coupons:o.coupons},function(){t(o.coupons[e].coupons)})}):t(!1)})},updateUserData:function(e){chrome.storage.local.set({slider:e.slider,current_action:e.action},function(){void 0!==e.profile&&chrome.storage.local.set({balance:e.profile.balance,userInfo:e.profile.info})})},_updatedNow:function(e){return $.each(e,function(t,o){e[t].lastUpdated=tmpstmp()}),e},updateShops:function(e){chrome.storage.local.get(function(t){API.get("shops/list",null,function(t){$.isEmptyObject(t)||chrome.storage.local.set({lastCallUpdateShops:tmpstmp(),topShops:bg._updatedNow(t.top),shops:bg._updatedNow(t.all),topCoupons:t.topCoupons},function(){e&&e()})})})},updateData:function(e){chrome.storage.local.get(function(t){bg.post({do:"updateData",mon:t.mon,shops_hash:t.shops_hash,coupons_hash:t.coupons_hash,lastdate:t.news_lastdate},function(o){$.isEmptyObject(o)||chrome.storage.local.set({monList:o.mon,mon:[],lastCallUpdateData:tmpstmp(),partners:$.isEmptyObject(o.shops)?t.partners:o.shops,coupons:$.isEmptyObject(o.coupons.coupons)?t.coupons:o.coupons.coupons,top_coupons:$.isEmptyObject(o.coupons.top_coupons)?t.top_coupons:o.coupons.top_coupons,shops_hash:o.shopsHash,coupons_hash:o.couponsHash},function(){e&&e()})})})},getHostName:function(e){if(null!==e){var t=e.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);return null!==t&&t.length>2&&"string"==typeof t[2]&&t[2].length>0?t[2]:null}return null},showCashbackNotifyIfNeeded:function(t){chrome.cookies.get({url:baseUrl,name:"actived_cashback"},function(o){e.getPartner(t.url,function(n){!1===n||n.plugin_hide||(!o||o.value==n.id)&&o||e.isActive(t.url,function(o){o||chrome.cookies.get({url:"http://"+e.getHostName(t.url)+"/",name:"smarty.sale_closed_notify"},function(e){(e&&1!=e.value||!e)&&chrome.tabs.sendMessage(t.id,{do:"notify",cashback:n.cashback,id:n.id,shop:n.title})})})})})},onChange:function(t,o,n,a,s){"number"==typeof window.pulseTimeout&&window.pulseTimeout>0&&e.clearTimeout(),"number"==typeof window.pulseInterval&&window.pulseInterval>0&&(e.clearInterval(),chrome.browserAction.setBadgeBackgroundColor({color:"#767998"})),currentDomain=baseUrl+"/#add_request="+e.getHostName(t),e.isLogged(function(n){e.getPartner(t,function(i){!1===i||i.plugin_hide&&2!=i.plugin_hide?(chrome.browserAction.setIcon({path:"img/icons/icon"+(n?"":"_gray")+".png"}),chrome.browserAction.setBadgeText({text:""})):e.isActive(t,function(t){function a(){r.save(),r.clearRect(0,0,s.width,s.height),r.translate(.5*c.width,.5*c.height),r.scale(u,u),r.translate(.5*-c.width,.5*-c.height),r.drawImage(c,0,0,19,19),r.restore(),chrome.browserAction.setIcon({imageData:r.getImageData(0,0,s.width,s.height)}),m>=3&&1==u&&(m=0,e.clearInterval(),u=1,l=.1,e.clearTimeout(),window.pulseTimeout=setTimeout(function(){e.clearInterval(),window.pulseInterval=setInterval(a,50)},3e3)),((u+=l)<.8||u>1.7)&&(l=-l,m++,d="#D42258"==d?"#767998":"#D42258",chrome.browserAction.setBadgeBackgroundColor({color:d}))}if(t&&($isGreen=!0),t)chrome.tabs.sendMessage(o,{do:"remove_notify"}),chrome.browserAction.setIcon({path:"img/icons/icon"+(t&&n?"":"_gray")+".png"});else{var s=document.getElementById("canvas"),c=document.getElementById("image"),r=s.getContext("2d"),u=1,l=.1,m=0,d="#767998";e.clearInterval(),window.pulseInterval=setInterval(a,50)}t?(chrome.browserAction.setBadgeBackgroundColor({color:"#50D686"}),chrome.browserAction.setBadgeText({text:" OK "})):chrome.browserAction.setBadgeText({text:i.badge})},a,s)})})},clearInterval:function(){"number"==typeof window.pulseInterval&&clearInterval(window.pulseInterval)},clearTimeout:function(){"number"==typeof window.pulseInterval&&clearTimeout(window.pulseTimeout)},setCashback:function(t){e.getPartner(t,function(t){e.isLogged(function(o){o&&0!=o&&chrome.cookies.set({url:"http://"+e.getHostName(t.url)+"/",name:"smarty.sale_cashback",value:o,path:"/",domain:e.getHostName(t.url)},function(){chrome.cookies.set({url:"http://"+e.getHostName(t.url)+"/",name:"smarty.sale_cashback_daily",value:o,path:"/",domain:e.getHostName(t.url),expirationDate:Math.floor(Date.now()/1e3|0)+43200},function(){chrome.runtime.sendMessage({do:"init"})})})})})},getCashback:function(t,o,n,a){function s(){}n=!1,chrome.windows.getCurrent(function(o){chrome.tabs.query({active:!0,windowId:o.id},function(o){e.isLogged(function(e){var i={url:baseUrl+(t>0?"/shops/"+t+"/go"+(a?"?deeplink="+encodeURIComponent(o[0].url)+"&":"?"):"/coupons/go/"+Math.abs(t)+"?")+"from_ext=1&utm_source=plugin&utm_medium="+browser+"&utm_term="+e+"&utm_content=go",active:!0};n?chrome.tabs.create(i,s):chrome.tabs.update(o[0].id,i,s)})})})},isLogged:function(e){chrome.cookies.get({url:baseUrl,name:"ext_user_id"},function(t){e(t&&t.value?t.value:0)})},getPartner:function(t,o){chrome.storage.local.get("shops",function(n){var a=e.getHostName(t),s=!1;$.isEmptyObject(n.shops)||$.each(n.shops,function(t,o){var n=new RegExp("(^|\\.)"+e.getHostName(o.url)+"$");void 0!==a&&null!==a&&a.match(n)&&(s=o)}),o(s)})},getQueryString:function(e){return e.slice(e.indexOf("?")+1)},detectUTM:function(e){return null!==e.match("utm_source")||null!==e.match("admitad_uid")||null!==e.match("aff_platform")},setUTM:function(t,o){e.detectUTM(o)&&e.getPartner(o,function(n){chrome.cookies.set({url:"http://"+e.getHostName(n.url)+"/",name:"smarty.sale_utm",value:t+"|"+e.getQueryString(o),path:"/",domain:e.getHostName(n.url),expirationDate:Math.floor(Date.now()/1e3|0)+43200})})},isActive:function(t,o,n,a){e.getPartner(t,function(s){!a&&e.detectUTM(t)&&chrome.cookies.get({url:"http://"+e.getHostName(t)+"/",name:"smarty.sale_utm"},function(o){if(void 0!==o&&null!=o){var n=o.value.split("|"),a=decodeURIComponent(t);if(void 0!==a)var s=a.match(n[1]);t.match(n[1])||s||e.removeCookies(t,function(){},!0)}}),chrome.cookies.get({url:"http://"+e.getHostName(t)+"/",name:"smarty.sale_cashback_daily"},function(i){chrome.cookies.get({url:"http://"+e.getHostName(t)+"/",name:"smarty.sale_cashback"},function(c){if(void 0!==a&&a>0){if(a==s.id)return e.setCashback(t),chrome.cookies.remove({url:baseUrl,name:"actived_cashback"}),e.setUTM(a,t),o(!0),!0}else if(-1!=n){if(n){var r=new RegExp(baseUrl+"/([a-z]{2}/|)shops/[0-9]+/go","gi"),u=new RegExp(baseUrl+"/([a-z]{2}/|)coupons/go/[0-9]+","gi");if(n.match(r)||n.match(u))return e.setCashback(t),e.setUTM(a,t),o(!0),!0;if(0!=s){var l=new RegExp("(^|\\.)"+e.getHostName(s.url)+"$");e.getHostName(n).match(l)||(c=null)}}_log("REF - "+n),c&&i||(e.removeCookies(t),_log("remove4"))}e.isLogged(function(e){o(c&&c.value==e&&i&&i.value==e)})})})})},removeCookies:function(t,o,n){chrome.cookies.remove({url:"http://"+e.getHostName(t)+"/",name:"smarty.sale_utm"},function(){chrome.cookies.remove({url:"http://"+e.getHostName(t)+"/",name:"smarty.sale_cashback"},function(){chrome.cookies.remove({url:"http://"+e.getHostName(t)+"/",name:"smarty.sale_cashback_daily"},function(){chrome.windows.getCurrent(function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){n&&bg.onChange(e[0].url,e[0].id,"complete")})}),o&&o()})})})},notifyAction:function(e,t){var o=e.split("_")[1];API.post("notify/status/"+o,{opened:t?1:0}),chrome.storage.local.get(function(n){$.isEmptyObject(n.notifications)||($.each(n.notifications,function(a,s){s.id==o&&(n.notifications[a].viewed=!0,t&&chrome.tabs.create({url:s.url,active:!0},function(){chrome.notifications.clear(e)}))}),chrome.storage.local.set({notifications:n.notifications}))})}})},bg=new BG;$isGreen||chrome.browserAction.setBadgeBackgroundColor({color:"#767998"});