function replaceMessages(t){$(t).find("[i18n]").each(function(){$(this).attr("placeholder")?$(this).attr("placeholder",chrome.i18n.getMessage($(this).attr("i18n"))):$(this).text(chrome.i18n.getMessage($(this).attr("i18n")))})}chrome.runtime.getBackgroundPage(function(t){var e=new _api(t),o=t.bg,s=function(){var e=this;$.extend(this,{baseUrl:t.baseUrl,log:t._log,init:function(){chrome.windows.getCurrent(function(s){chrome.tabs.query({active:!0,windowId:s.id},function(s){var a=s[0].url;chrome.storage.local.get(function(s){o.isLogged(function(n){o.getPartner(a,function(i){var c=!1;if(!1!==i&&(c=1==i.plugin_hide),!1===i||c)o.getHostName(a)===o.getHostName(t.baseUrl)?e.showShops(!0):e.noCashBack(c);else{if($.isEmptyObject(s.balance))l=!0;else if($.each(s.balance,function(t,e){e<=0&&delete s.balance[t]}),$.isEmptyObject(s.balance))var l=!0;if($coupons=new Object,void 0===s.coupons&&(s.coupons={}),void 0!==s.coupons[i.id]&&($coupons=s.coupons[i.id].coupons),o.updateCouponsIfNeeded(i.id,function(t){t&&($tpl=Mustache.render($("#activeCashbackCoupons").html(),{coupons:t,logo:i.logo}),$("#couponsList").html($tpl),$("[data-active-coupons]").scrollbar())}),$.isEmptyObject($coupons))var r=!0;if($.isEmptyObject(s.slider))var h=!0;void 0===s.userInfo&&(s.userInfo=[]),o.isActive(a,function(e){$tpl=Mustache.render($("#isCashBacks").html(),{cashback:i.cashback,shop:i.title,id:i.id,avatar:s.userInfo.avatar,user_name:s.userInfo.name,hide_coupons:r,logo:i.logo,all_shops_url:t.baseUrl+"/shops",balance:s.balance,user_id:n,signup_link:t.baseUrl+"/#signup",actived:e,hide_slider:h,slider:s.slider,hide_balance:l,url:i.url}),$("body").removeClass("width"),$("#content").html($tpl),$.isEmptyObject($coupons)||($tpl=Mustache.render($("#activeCashbackCoupons").html(),{coupons:$coupons,logo:i.logo}),$("#couponsList").html($tpl)),replaceMessages($("#content")),e&&!h&&void 0!==s.slider&&s.slider.length>1&&$(".slider > ul").bxSlider({pager:!0,speed:1e3,controls:!0,prevText:"",nextText:"",mode:"fade",touchEnabled:!1,adaptiveHeight:!0}),$("[data-active-coupons]").scrollbar()},-1)}})})})})})},showShops:function(t){chrome.storage.local.get(function(e){$tpl=Mustache.render($("#shopsList").html(),{shops:Object.keys(e.topShops).map(function(t){return e.topShops[t]}),top_coupons:e.topCoupons,current_action:e.current_action,hideBackButton:void 0!==t||null}),$("#content").html($tpl),replaceMessages($("#content")),$("body").addClass("width"),$(".scrollbar-macosx").scrollbar()})},showLoginForm:function(){$("body").removeClass("width"),$tpl=Mustache.render($("#loginForm").html(),{signup_link:t.baseUrl+"/#signup",login_url:t.baseUrl+"/#login"}),$("#content").html($tpl),replaceMessages($("#content"))},noCashBack:function(e){e&&$(document).on("click","#catalog-url",function(){chrome.runtime.sendMessage({do:"catalogUrl"})}),$tpl=Mustache.render($("#noCashback").html(),{url:t.baseUrl+"/shops",request_url:t.currentDomain,hidden:e}),$("body").removeClass("width"),$("#content").html($tpl),replaceMessages($("#content"))},getCashBack:function(t,s,a,n){o.isLogged(function(i){i&&0!=i?(o.getCashback(t,s,a,n),window.close()):e.showLoginForm()})},searchWait:function(){$("[data-search-button]").hide(),$("[data-search-wait]").show(),$("#searchButton").data("clicked",!0)},searchUnwait:function(){$("[data-search-button]").show(),$("[data-search-wait]").hide()},wait:function(){$("[data-enter-button]").hide(),$("[data-wait]").show(),$("#do-login-button").data("clicked",!0)},unWait:function(){$("[data-enter-button]").show(),$("[data-wait]").hide(),$("#do-login-button").data("clicked",!1)}})};$(function(){!function(){var a=new s;a.init(),$(document).on("click","[data-tab]",function(t){if(t.preventDefault(),!$(this).hasClass("active")){$div=$(this).data("tab"),$(this).addClass("active");var e=$("#search").val().length;"1"!==$(this).attr("data-searchable")&&($("[data-tab]").attr("data-searchable","1"),$("#search").trigger("searchable")),$("[data-tab]").not($(this)).removeClass("active"),$("."+$("[data-tab]").not($(this)).data("tab")).hide(),$("."+$div).show(),"shopItems"===$div?($("#topShops")[e?"hide":"show"](),$("#allShopsList")[e?"show":"hide"](),$(".shopItems [data-not-found]")[$(".shopItem:visible").length?"hide":"show"]()):($("#topCoupons")[e?"hide":"show"](),$("#allShopsList")[e?"show":"hide"](),$(".couponItems [data-not-found]")[$(".couponItem:visible").length?"hide":"show"]()),$(".shopItems .border:visible:last").hide(),$(".couponItems .border:visible:last").hide(),$(".scrollbar-macosx").scrollbar()}}),$(document).on("mouseenter",".shopItem, .couponItem, .couponActiveItem",function(){$(this).addClass("hover"),$(this).next(".border").css("visibility","hidden"),$(this).prev(".border").css("visibility","hidden")}),$(document).on("mouseleave",".shopItem, .couponItem, .couponActiveItem",function(){$(this).removeClass("hover"),$(this).next(".border").css("visibility","visible"),$(this).prev(".border").css("visibility","visible")}),$(document).on("click","#searchButton",function(){if($(this).data("clicked"))return!1;$("#search").trigger("searchable")}),$(document).on("keyup searchable","#search",$.debounce(function(t){if("keyup"===t.type&&($("[data-tab]").removeAttr("data-searchable"),$("#searchButton").data("clicked",!1)),$("#searchButton").data("clicked"))return!1;$text=$.trim($(this).val()),$text?"shopItems"===$("[data-tab].active").data("tab")?function(){if($text.length<3)$("#allShopsList").html("<div>"+chrome.i18n.getMessage("min3Symobls")+"</div>").show(),$(".scrollbar-macosx").scrollbar(),$("#topShops").hide();else{var t=setTimeout(function(){a.searchWait()},500);e.get("shops/search",{searchQuery:$text},function(e){$tpl=Mustache.render($("#shopsListTpl").html(),{shops:e.shops}),null!==e.group&&($tpl='<div style="margin: 0px 12px;"><strong>'+e.group+"</strong> "+chrome.i18n.getMessage("youCanBuy")+"</div>"+$tpl),$("#allShopsList").html($tpl).show(),replaceMessages($("#allShopsList")),$(".scrollbar-macosx").scrollbar(),$("#topShops").hide(),"number"==typeof t&&clearTimeout(t),a.searchUnwait()})}}():function(){if($text.length<3)$("#allCoupons").html("<div>"+chrome.i18n.getMessage("min3Symobls")+"</div>").show(),$(".scrollbar-macosx").scrollbar(),$("#topCoupons").hide();else{var t=setTimeout(function(){a.searchWait()},500);e.get("coupons/search",{query:$text},function(e){$tpl=Mustache.render($("#couponsListTpl").html(),{coupons:e}),$("#allCoupons").html($tpl).show(),replaceMessages($("#allCoupons")),$(".scrollbar-macosx").scrollbar(),$("#topCoupons").hide(),"number"==typeof t&&clearTimeout(t),a.searchUnwait()})}}():($("#allCoupons").html("").hide(),$("#topCoupons").show(),$("#allShopsList").html("").hide(),$("#topShops").show(),$(".shopItem").show(),$(".couponItem").show(),$(".border").show()),$(".shopItems .border:visible:last").hide(),$(".couponItems .border:visible:last").hide(),$(".shopItems [data-not-found]")[$(".shopItem:visible").length?"hide":"show"](),$(".couponItems [data-not-found]")[$(".couponItem:visible").length?"hide":"show"]()},300)),$(document).on("click","#show-login-form",function(){a.showLoginForm()}),$(document).on("click","#show-shops",function(){a.showShops()}),$(document).on("click","#main-page",function(){a.init()}),$(document).on("click","#do-login-button",function(){if($(this).data("clicked"))return!1;a.wait(),e.post("login",{login:$("#email_input").val(),password:$("#pass_input").val()},function(t){t.result?o.updateShops(function(){a.unWait(),window.location.reload(),chrome.runtime.sendMessage({do:"login"})}):(a.unWait(),$("#email_input").css("border-color","red"),$("#pass_input").css("border-color","red"),$("#label_enter").text(chrome.i18n.getMessage("wrongPassword")).css("color","red"),setTimeout(function(){$("#label_enter").text(chrome.i18n.getMessage("enter")).css("color","")},2e3))})}),$(document).on("click","[data-get-cashback]",function(t){a.getCashBack($(this).data("id"),$(this).data("url"),$(this).data("newtab"),1==$(this).data("get-cashback"))}),chrome.runtime.onMessage.addListener(function(t,e){switch(t.do){case"init":a.init()}}),$(document).on("click","[data-logout-button]",function(){a.showLoginForm(),chrome.runtime.sendMessage({do:"logout"}),setTimeout(function(){e.post("logout")},500)}),$(document).on("click","[data-logo-click]",function(t){t.preventDefault(),chrome.runtime.sendMessage({do:"logoClick"})}),$(document).on("click","[data-login-url]",function(){chrome.tabs.query({active:!0},function(e){chrome.runtime.sendMessage({do:"goToUrl",url:t.baseUrl+"/?return_url="+e[0].url+"#login"}),window.close()})})}()})});