<style>
    .hl-template-html {
        max-width: 540px;
        resize: vertical;
        width: 100%;
        height: 300px;
    }
</style>

<template>
    <div :id="id" class="modal" :class="{show: state.visible}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" @click="hide()">×</button>
                    <button type="button" class="btn btn-default" @click="hide()">Cancel</button>
                    <button type="button" class="btn btn-primary"
                            @click="save($event).then(afterSave)">OK
                    </button>
                </div>
                <div class="modal-body">
                    <textarea class="hl-template-html">
                        <div id="bn_WETPNH5v46">
                            <div style="margin:0 !important;padding:0 !important;position:relative !important;overflow:hidden !important;width:100% !important;">
                                <table style="width:100% !important;border-spacing:1px !important;table-layout:auto !important;background-color:#f9f9f9 !important;-webkit-hyphens:auto !important;-moz-hyphens:auto !important;-ms-hyphens:auto !important;hyphens:auto !important;word-break:break-word !important;">
                                    <tbody>
                                    <tr>
                                        <td style="padding:6px !important;width:100% !important;"
                                            class="rec-adv-box-533">
                                            <a href="yhqv" target="_blank" rel="nofollow"
                                               style="text-align:center !important;" class="rec-adv-box-cont"
                                               data-i="0">
                                                <div style="margin:3px  auto !important;width:200px !important;height:200px !important;"
                                                     class="rec-adv-box-image-box">
                                                    <img src="//st5.recreativ.ru/tizers/200/43/tiz-533_15300099.jpg"
                                                         style="width:200px !important;height:200px !important;margin:0 !important;padding:0 !important;"
                                                         class="rec-adv-box-img" data-i="0">
                                                    <img src="//recreativ.ru/img/brand_533.png"
                                                         style="margin:3px  auto !important;width:200px !important;height:200px !important;"
                                                         class="rec-adv-box-logo">
                                                </div>
                                                <div style="font:15px Tahoma !important;text-decoration: none !important;font-weight:bold !important;float:none !important;margin:0 !important;padding:0 !important;"
                                                     class="rec-adv-box-title">Meizu </div>
                                                <div style="font:14px Tahoma !important;text-decoration: none !important;font-weight:normal !important;float:none !important;margin:0 !important;padding:0 !important;"
                                                     class="rec-adv-box-desc">Meizu M5 Note 32GB Grey (Международная версия) </div>
                                                <div style="font:15px Tahoma !important;font-weight:normal !important;float:none !important;margin:0 !important;padding:0 !important;text-decoration:none !important;"
                                                     class="rec-adv-box-link">rozetka.ua</div>
                                                <div style="font:14px Tahoma !important;font-weight:bold !important;float:none !important;margin:0 !important;padding:0 !important;"
                                                     class="rec-adv-box-price">4 299 грн</div>
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                    <td style="text-align:center !important; border: 1px solid #f9f9f9 !important;padding:5px !important;background-color:#f9f9f9 !important;vertical-align:top !important;width:100% !important;">
                        <a href="yhqv" target="_blank" rel="nofollow"
                           style="text-decoration:none !important;display:block !important;margin:0 !important;padding:0 !important;"
                           data-i="2"><img src="//st5.recreativ.ru/tizers/200/646/tiz-533_5509215.jpg"
                                           style="margin:3px !important;padding:0 !important;border: 0 !important;width:200px !important;height:200px !important;display:inline !important;"
                                           data-i="2">
                            <div style="font:15px Tahoma !important;color:#000000 !important;text-decoration:none !important;font-weight:bold !important;float:none !important;margin:0 !important;padding:0 !important;">
                                Новый Стиль
                            </div>
                            <div style="font:14px Tahoma !important;color:#494444 !important;text-decoration: none !important;font-weight:normal !important;float:none !important;margin:0 !important;padding:0 !important;"
                            >Кресло Новый Стиль Drive P ECO-30
                </div>
                <div style="font:15px Tahoma !important;color:#009a28 !important;font-weight:normal !important;float:none !important;margin:0 !important;padding:0 !important;text-decoration:none !important;border:0 !important;">
                    rozetka.ua
                </div>
                <div style="font:14px Tahoma !important;font-weight:bold !important;float:none !important;margin:0 !important;padding:0 !important;color:#F0690F !important;">
                    3 225 грн
                </div>
                        </a></td></tr>
                                    <tr>
                    <td style="text-align:center !important; border: 1px solid #f9f9f9 !important;padding:5px !important;background-color:#f9f9f9 !important;vertical-align:top !important;width:100% !important;">
                        <a href="yhqv" target="_blank" rel="nofollow"
                           style="text-decoration:none !important;display:block !important;margin:0 !important;padding:0 !important;"
                           data-i="3"><img src="//st5.recreativ.ru/tizers/200/447/tiz-533_14782574.jpg"
                                           style="margin:3px !important;padding:0 !important;border: 0 !important;width:200px !important;height:200px !important;display:inline !important;"
                                           data-i="3">
                            <div style="font:15px Tahoma !important;color:#000000 !important;text-decoration:none !important;font-weight:bold !important;float:none !important;margin:0 !important;padding:0 !important;">
                                Halmar
                            </div>
                            <div style="font:14px Tahoma !important;color:#494444 !important;text-decoration: none !important;font-weight:normal !important;float:none !important;margin:0 !important;padding:0 !important;"
                            >Кресло Halmar Desmond Черное
                </div>
                <div style="font:15px Tahoma !important;color:#009a28 !important;font-weight:normal !important;float:none !important;margin:0 !important;padding:0 !important;text-decoration:none !important;border:0 !important;">
                    rozetka.ua
                </div>
                <div style="font:14px Tahoma !important;font-weight:bold !important;float:none !important;margin:0 !important;padding:0 !important;color:#F0690F !important;">
                    3 420 грн
                </div>
                </a></td></tr>
                                    </tbody>
                                </table>
                                <a href="//recreativ.ru"
                                   style="width:61px !important;height:18px !important;padding:0px !important;display:block !important;background:left top url(//recreativ.ru/img/logo.png) no-repeat !important;position:absolute !important;top:0 !important;right:-23px;overflow:hidden !important;"
                                   onmouseover="this.setAttribute('data-r','18px');this.style.right='18px'"
                                   onmouseout="this.setAttribute('data-r','-23px');setTimeout((function(){this.style.right=this.getAttribute('data-r');}).bind(this),1000)"
                                   title="Рекламная сеть Recreativ - с нами Вас заметят!" target="_blank">
                                </a>
                                <a href="#"
                                   style="width:18px !important;height:18px !important;padding:0px !important;display:block !important;background:left top url('//recreativ.ru/img/x.png') no-repeat !important;position:absolute !important;top:0 !important;right:0px !important;overflow:hidden !important;"
                                   data-i="z" title="скрыть рекламу">
                                </a>
                            </div>
                        </div>
                    </textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" @click="hide()">Cancel</button>
                    <button type="button" class="btn btn-primary"
                            @click="click">OK
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    import {mapGetters, mapActions, mapMutations, mapState} from 'vuex'

    export default {
        name: 'html-loader',
        data () {
            return {
                id: 'hl-' + window.Math.random().toString(32).substr(2),
                searchString: /\<([\w\-]+)(\s*|[\s*\>])+((([\w\-]+)(\=\"([\w\s\:\!\;\.\,\-\_\%\/\#]*)\"(\s*|[\s*\>])+)*)+)?\>*/
            }
        },
        computed: {
            ...mapState({
                'state': 'htmlLoader'
            })
        },
//        props: ['show', 'loader'],
        methods: {
            ...mapActions('htmlLoader', [
                'show',
                'hide',
                'save',
                'setId',
            ]),
            click(event){
                let s = '#' + this.id + ' textarea.hl-template-html'
                let html = document.querySelector(s).value
                this.parseHtml(html)
                this.save(html).then(this.afterSave({html}))
            },
            afterSave({html}){
                let el = document.createRange().createContextualFragment(html)
                console.log(el)
                this.$root.$emit('htmlLoaded', {html, el})
                this.hide()
            },
            parseHtml(html){
                var result = {el:{}, children:[]}
                html = html.trim()
                var r = new RegExp(this.searchString, 'g')
                var match = r.exec(html)
                console.log('parse:', match, r)
            }
        },
        created () {
            this.$store.dispatch('htmlLoader/setId', {id: this.id})
        }
    }
</script>
